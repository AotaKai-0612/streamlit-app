# -----------------------------------------------------------
# ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã¨APIã‚­ãƒ¼ã®è¨­å®š
# -----------------------------------------------------------
from dotenv import load_dotenv
import os
from googleapiclient.discovery import build
from openai import OpenAI
import pandas as pd
import json
from tqdm import tqdm
import time

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
load_dotenv()

# YouTube Data APIã‚­ãƒ¼
try:
    YOUTUBE_API_KEY = os.getenv('YOUTUBE_API_KEY')
    if not YOUTUBE_API_KEY:
        raise ValueError("YOUTUBE_API_KEY ãŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    youtube = build('youtube', 'v3', developerKey=YOUTUBE_API_KEY)
    print("âœ… YouTube APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚")
except Exception as e:
    print(f"ğŸ›‘ YouTube APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")

# OpenAI APIã‚­ãƒ¼
try:
    OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')
    if not OPENAI_API_KEY:
        raise ValueError("OPENAI_API_KEY ãŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    client = OpenAI(api_key=OPENAI_API_KEY)
    print("âœ… OpenAI APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚")
except Exception as e:
    print(f"ğŸ›‘ OpenAI APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")

# -----------------------------------------------------------
# ã‚¹ãƒ†ãƒƒãƒ—3ï¼šYouTubeã‚³ãƒ¡ãƒ³ãƒˆå–å¾—é–¢æ•°
# -----------------------------------------------------------
def get_youtube_comments(video_id, max_comments=200):
    comments = []
    try:
        request = youtube.commentThreads().list(
            part="snippet",
            videoId=video_id,
            maxResults=100,
            textFormat="plainText",
            order="relevance"  # â˜…äººæ°—é †ã§å–å¾—
        )

        while request and len(comments) < max_comments:
            response = request.execute()
            for item in response["items"]:
                comment = item["snippet"]["topLevelComment"]["snippet"]["textDisplay"]
                comments.append(comment)
            request = youtube.commentThreads().list_next(request, response)

        print(f"âœ… {len(comments)}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚")
        return comments[:max_comments]
    except Exception as e:
        print(f"ğŸ›‘ ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return []

# -----------------------------------------------------------
# ã‚¹ãƒ†ãƒƒãƒ—4ï¼šGPTã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆåˆ†æé–¢æ•°ï¼ˆâ˜…Colabã®å®šç¾©ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
# -----------------------------------------------------------
def analyze_comment(comment_text):
    prompt = f"""
    ã‚ãªãŸã¯YouTubeã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
    ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«ã€å³å¯†ã«ã€‘å¾“ã£ã¦ã€æŒ‡å®šã•ã‚ŒãŸYouTubeã‚³ãƒ¡ãƒ³ãƒˆã‚’6ã¤ã®ç‰¹å¾´é‡ã§åˆ†æã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
    ã‚³ãƒ¡ãƒ³ãƒˆã®è¡¨é¢ä¸Šã®æ„å‘³ã ã‘ã§ãªãã€æ–‡è„ˆçš„ãƒ»åèªçš„ãªæ„å‘³ï¼ˆä¾‹ï¼šã€Œè‰¯ã„å‹•ç”»ãªã®ã§ã„ã„ã­ã‚’äºŒå›æŠ¼ã—ã¾ã—ãŸï¼ã€ãªã©ã®çš®è‚‰è¡¨ç¾ï¼‰ã‚‚è€ƒæ…®ã—ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

    # åˆ†æãƒ«ãƒ¼ãƒ«

    ##  1. æ”»æ’ƒæ€§ (Aggressiveness)
    - **ä½•ã‚’æ¸¬ã‚‹ã‹**: ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã¾ã‚Œã‚‹ã€ä»–è€…ã¸ã®ç›´æ¥çš„ãªæ•µæ„ã€ä¾®è¾±ã€è„…è¿«ã®åº¦åˆã„ã€‚
    - **ãƒ¬ãƒ™ãƒ«0: ãªã—**: æ•¬æ„ãŒæ‰•ã‚ã‚Œã¦ã„ã‚‹ã€ã‚‚ã—ãã¯ä¸­ç«‹çš„ã€‚ç„¡ç¤¼ãªè¨€è‘‰é£ã„ãŒä¸€åˆ‡å«ã¾ã‚Œãªã„ã€‚ï¼ˆä¾‹: ã€Œã„ã¤ã‚‚å‹•ç”»ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«1: ä½**: ç›¸æ‰‹ã‚’å°é¦¬é¹¿ã«ã™ã‚‹ã€è¦‹ä¸‹ã™ã‚ˆã†ãªè¡¨ç¾ã€‚ç›´æ¥çš„ãªæš´è¨€ã§ã¯ãªã„ãŒã€ç„¡ç¤¼ã§ç›¸æ‰‹ã‚’ä¸å¿«ã«ã•ã›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ï¼ˆä¾‹: ã€Œãã‚“ãªã“ã¨ã‚‚çŸ¥ã‚‰ãªã„ã®ï¼Ÿã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«2: ä¸­**: ç‰¹å®šã®å€‹äººã‚„æ„è¦‹ã«å¯¾ã™ã‚‹ç›´æ¥çš„ãªæ‚ªå£ã€äººæ ¼å¦å®šã€å˜²ç¬‘ã€‚ã€Œãƒã‚«ã€ã€Œã‚­ãƒ¢ã„ã€ãªã©ã€æ˜ç¢ºãªæ•µæ„ã‚„ä¾®è¾±ãŒå«ã¾ã‚Œã‚‹ã€‚ï¼ˆä¾‹: ã€Œã“ã„ã¤ãƒã‚¸ã§é ­æ‚ªã„ãªã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«3: é«˜**: è„…è¿«ã€ãƒ˜ã‚¤ãƒˆã‚¹ãƒ”ãƒ¼ãƒã€è‡ªæ®ºã®æ•™å”†ãªã©ã€å¿ƒèº«ã®å®‰å…¨ã‚’è„…ã‹ã™è¡¨ç¾ã€‚ï¼ˆä¾‹: ã€Œã“ã†ã„ã†å¥´ã¯ç¤¾ä¼šã‹ã‚‰æ¶ˆãˆã‚ã€‚ã€ï¼‰

    ##  2. æŒ‘ç™ºæ€§ (Provocation)
    - **ä½•ã‚’æ¸¬ã‚‹ã‹**: çš®è‚‰ã€å«Œå‘³ã€æ±ºã‚ã¤ã‘ã€ç…½ã‚Šãªã©ã€ç›¸æ‰‹ã®æ„Ÿæƒ…ã‚’é€†æ’«ã§ã—ã¦åå¿œã‚’å¼•ãå‡ºãã†ã¨ã™ã‚‹æ„å›³ã®åº¦åˆã„ã€‚
    - **ãƒ¬ãƒ™ãƒ«0: ãªã—**: èª å®Ÿã§ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãªè¡¨ç¾ã€‚è£ã®æ„å›³ã‚’æ„Ÿã˜ã•ã›ãªã„ã€‚ï¼ˆä¾‹: ã€Œç·¨é›†ãŠç–²ã‚Œæ§˜ã§ã™ï¼ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«1: ä½**: è»½åº¦ã®çš®è‚‰ã‚„å«Œå‘³ã€‚åˆ†ã‹ã‚‹äººã«ã¯åˆ†ã‹ã‚‹ãŒã€æ–‡å­—é€šã‚Šå—ã‘å–ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ãªã€æ›–æ˜§ã•ã‚’å«ã‚€è¡¨ç¾ã€‚ï¼ˆä¾‹: ã€Œè¬ç½ªå‹•ç”»ã§ãŒã£ã½ã‚Šç¨¼ã’ã¦ã‚ˆã‹ã£ãŸã­ã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«2: ä¸­**: æ˜ç¢ºãªã€Œä¸Šã‹ã‚‰ç›®ç·šã€ã€ãƒ¬ãƒƒãƒ†ãƒ«è²¼ã‚Šã€æ„å›³çš„ãªæšã’è¶³å–ã‚Šã€‚ã€Œä¿¡è€…ã€ã€Œã‚¢ãƒ³ãƒã€ãªã©ã®è¨€è‘‰ã‚’ä½¿ã„ã€å¯¾ç«‹ã‚’ç…½ã‚‹ã€‚ï¼ˆä¾‹: ã€Œä¿¡è€…ã•ã‚“ãŸã¡ãŒå¿…æ­»ã«æ“è­·ã—ã¦ã¦è‰ã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«3: é«˜**: è­°è«–ã‚’ç ´å£Šã—ã€å ´ã‚’è’ã‚‰ã™ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸæ‚ªè³ªãªç…½ã‚Šã€‚ï¼ˆä¾‹: ã€Œã¯ã„è«–ç ´ã€‚åè«–ã§ããªã„ãªã‚‰ä¿ºã®å‹ã¡ã­ã€‚ã€ï¼‰

    ##  3. æœ‰ç”¨æ€§ (Usefulness)
    - **ä½•ã‚’æ¸¬ã‚‹ã‹**: å‹•ç”»ã®å†…å®¹ã‚„ä»–ã®è¦–è´è€…ã«å¯¾ã—ã¦ã€æœ‰ç›Šãªä¾¡å€¤ã‚’æä¾›ã—ã¦ã„ã‚‹åº¦åˆã„ã€‚
    - **ãƒ¬ãƒ™ãƒ«0: ãªã—**: ã€Œè‰ã€ã€Œå¥½ãã€ãªã©ã€ä¸­èº«ã®ãªã„ç›¸æ§Œã‚„å˜ãªã‚‹æ„Ÿæƒ…è¡¨ç¾ã€‚ï¼ˆä¾‹: ã€Œè‰ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«1: ä½**: å…·ä½“çš„ãªæ ¹æ‹ ã®ãªã„ã€å€‹äººã®æ„Ÿæƒ³ã‚„æ¼ ç„¶ã¨ã—ãŸæ„è¦‹ã€‚ï¼ˆä¾‹: ã€Œä»Šå›ã®å‹•ç”»é¢ç™½ããªã‹ã£ãŸãªã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«2: ä¸­**: å…·ä½“çš„ãªæŒ‡æ‘˜ã€æ”¹å–„ææ¡ˆã€æ ¹æ‹ ã®ã‚ã‚‹æ„è¦‹ã€ä½“é¨“è«‡ãªã©ã€å‚è€ƒã«ãªã‚‹æƒ…å ±ã‚’å«ã‚€ã€‚ï¼ˆä¾‹: ã€ŒBGMãŒå¤§ãã™ãã¦ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒèãå–ã‚Šã¥ã‚‰ã‹ã£ãŸã§ã™ã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«3: é«˜**: å°‚é–€çš„ãªçŸ¥è­˜ã«åŸºã¥ãæ·±ã„åˆ†æã€ãƒ‡ãƒ¼ã‚¿ã‚„å‡ºå…¸ã‚’ç”¨ã„ãŸå®¢è¦³çš„ãªè¨‚æ­£ãªã©ã€æ¥µã‚ã¦ä¾¡å€¤ã®é«˜ã„æƒ…å ±ã‚’å«ã‚€ã€‚ï¼ˆä¾‹: ã€Œã“ã®ä»¶ã€ã€‡ã€‡ã¨ã„ã†æ³•å¾‹ã®ç¬¬â–³æ¡ã«æŠµè§¦ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã€ï¼‰

    ##  4. æ„Ÿæƒ…æ¥µæ€§ (Sentiment Polarity)
    - **ä½•ã‚’æ¸¬ã‚‹ã‹**: ã‚³ãƒ¡ãƒ³ãƒˆå…¨ä½“ã®æ„Ÿæƒ…çš„ãªãƒˆãƒ¼ãƒ³ã€‚
    - **ãƒ¬ãƒ™ãƒ«-2: å¼·ã„ãƒã‚¬ãƒ†ã‚£ãƒ–**: å¼·ã„æ€’ã‚Šã€æ†ã—ã¿ã€è»½è”‘ãªã©ã€‚ï¼ˆä¾‹: ã€Œå²ä¸Šæœ€æ‚ªã®å‹•ç”»ã€‚æ™‚é–“ã®ç„¡é§„ã ã£ãŸã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«-1: ãƒã‚¬ãƒ†ã‚£ãƒ–**: æ‰¹åˆ¤ã€å¤±æœ›ã€ä¸æº€ãªã©ã€‚ï¼ˆä¾‹: ã€ŒæœŸå¾…ã—ã¦ãŸå†…å®¹ã¨é•ã£ã¦å°‘ã—æ®‹å¿µã§ã—ãŸã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«0: ä¸­ç«‹**: äº‹å®Ÿã®è¨˜è¿°ã€è³ªå•ãªã©ã€æ„Ÿæƒ…çš„ãªè‰²åˆã„ãŒã»ã¨ã‚“ã©ãªã„ã€‚ï¼ˆä¾‹: ã€Œã“ã®å•†å“ã¯ã©ã“ã§è²·ãˆã¾ã™ã‹ï¼Ÿã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«+1: ãƒã‚¸ãƒ†ã‚£ãƒ–**: å¥½æ„ã€æ„Ÿè¬ã€è³è³›ãªã©ã€‚ï¼ˆä¾‹: ã€Œé¢ç™½ã‹ã£ãŸã§ã™ï¼æ¬¡å›ã®å‹•ç”»ã‚‚æ¥½ã—ã¿ã«ã—ã¦ã„ã¾ã™ï¼ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«+2: å¼·ã„ãƒã‚¸ãƒ†ã‚£ãƒ–**: æ„Ÿå‹•ã€ç†±ç‹‚ã€æ·±ã„æ„Ÿè¬ãªã©ã€‚ï¼ˆä¾‹: ã€Œæ„Ÿå‹•ã§æ¶™ãŒå‡ºã¾ã—ãŸã€‚ä¸€ç”Ÿã¤ã„ã¦ã„ãã¾ã™ï¼ã€ï¼‰

    ##  5. è‡ªå·±é¡•ç¤ºæ€§ (Self-display / Superiority)
    - **ä½•ã‚’æ¸¬ã‚‹ã‹**: è‡ªåˆ†ã®çŸ¥è­˜ã‚„çµŒé¨“ãªã©ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã€å„ªä½ã«ç«‹ã¨ã†ã¨ã™ã‚‹æ„å›³ã®åº¦åˆã„ã€‚
    - **ãƒ¬ãƒ™ãƒ«0: ãªã—**: è‡ªåˆ†ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹æ„å›³ãŒè¦‹ã‚‰ã‚Œãªã„ã€‚ï¼ˆä¾‹: ã€Œã“ã®è€ƒãˆæ–¹ã¯é¢ç™½ã„ã§ã™ã­ã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«1: ä½**: è©±é¡Œã«é–¢é€£ã—ãŸè‡ªåˆ†ã®ä½“é¨“è«‡ã‚„çŸ¥è­˜ã‚’ã€è£œè¶³æƒ…å ±ã¨ã—ã¦å…±æœ‰ã—ã¦ã„ã‚‹ã€‚ï¼ˆä¾‹: ã€Œç§ãŒæ˜”ã€‡ã€‡ã«è¡Œã£ãŸæ™‚ã‚‚åŒã˜ã‚ˆã†ãªæ„Ÿã˜ã§ã—ãŸã‚ˆã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«2: ä¸­**: æŠ•ç¨¿è€…ã®èª¬æ˜ã«å¯¾ã—ã€è¨‚æ­£ã‚„è£œè¶³ã¨ã„ã†å½¢ã§ã€ã‚ˆã‚Šå°‚é–€çš„ãªçŸ¥è­˜ã‚„è‡ªèº«ã®æˆåŠŸä½“é¨“ã‚’æŠ«éœ²ã—ã€æš—ã«å„ªä½æ€§ã‚’ç¤ºã—ã¦ã„ã‚‹ã€‚ï¼ˆä¾‹: ã€Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã¯åˆå¿ƒè€…å‘ã‘ã§ã™ã‚ˆã­ã€‚åƒ•ã¯ãã‚Œã§è³‡ç”£8æ¡ã„ãã¾ã—ãŸã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«3: é«˜**: çµŒæ­´ã€å¹´åãªã©ã‚’æç¤ºã—ã€ä»–è€…ã‚’ç›´æ¥çš„ãƒ»é–“æ¥çš„ã«è¦‹ä¸‹ã™ã€‚ï¼ˆä¾‹: ã€Œå¹´åã€‡ã€‡ä¸‡ä»¥ä¸‹ã®äººã¯ã“ã®å‹•ç”»è¦‹ã¦ã‚‚æ„å‘³ãªã„ã‚ˆã€‚ã€ï¼‰

    ##  6. æ–‡è„ˆä¾å­˜æ€§ (Context-dependency / In-groupness)
    - **ä½•ã‚’æ¸¬ã‚‹ã‹**: å†…è¼ªã«ã—ã‹çœŸæ„ãŒä¼ã‚ã‚‰ãªã„ã€å°‚é–€ç”¨èªã‚„å†…è¼ªãƒã‚¿ãŒã©ã®ç¨‹åº¦å«ã¾ã‚Œã¦ã„ã‚‹ã‹ã€‚
    - **ãƒ¬ãƒ™ãƒ«0: ãªã—**: èª°ãŒèª­ã‚“ã§ã‚‚ç†è§£ã§ãã‚‹ã€ä¸€èˆ¬çš„ã§å¹³æ˜“ãªè¨€è‘‰é£ã„ã€‚ï¼ˆä¾‹: ã€Œä»Šæ—¥ã®å¤•é£¯ã¯ã‚«ãƒ¬ãƒ¼ã«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«1: ä½**: éå»ã®å‹•ç”»ã§ã®å‡ºæ¥äº‹ã«è¨€åŠã—ã¦ã„ã‚‹ãŒã€æ–‡è„ˆã‚’çŸ¥ã‚‰ãªãã¦ã‚‚å¤§æ„ã¯æ¨æ¸¬ã§ãã‚‹ã€‚ï¼ˆä¾‹: ã€Œå‰å›ã®å‹•ç”»ã§è¨€ã£ã¦ãŸã€‡ã€‡ã®ä»¶ã€è§£æ±ºã—ã¦ã‚ˆã‹ã£ãŸï¼ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«2: ä¸­**: ãƒ•ã‚¡ãƒ³ã®é–“ã ã‘ã§é€šã˜ã‚‹æ„›ç§°ã€ãƒŸãƒ¼ãƒ ã€æ±ºã¾ã‚Šæ–‡å¥ãªã©ãŒä½¿ã‚ã‚Œã¦ãŠã‚Šã€åˆè¦‹ã«ã¯æ„å‘³ãŒåˆ†ã‹ã‚Šã«ãã„ã€‚ï¼ˆä¾‹: ã€Œã•ã™ãŒã€‡ã€‡ã•ã‚“ï¼ˆãƒ•ã‚¡ãƒ³ã®æ„›ç§°ï¼‰ã€ä»Šæ—¥ã‚‚å¹³å¸¸é‹è»¢ã§å®‰å¿ƒã—ãŸã€‚ã€ï¼‰
    - **ãƒ¬ãƒ™ãƒ«3: é«˜**: èƒŒæ™¯çŸ¥è­˜ãŒãªã‘ã‚Œã°ã€ã‚³ãƒ¡ãƒ³ãƒˆã®æ„å‘³ã‚’å…¨ãç†è§£ã§ããªã„ã€‚ï¼ˆä¾‹: ã€Œä»Šæ—¥ã®å‹•ç”»ã¯å®Œå…¨ã«ã€ä¾‹ã®ã‚ã®ä»¶ã€ã ãªâ€¦ã€ï¼‰
    
    æœ€å¾Œã«ç·åˆã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã€ãªãœãã®ã‚ˆã†ã«è©•ä¾¡ã‚’ã—ãŸã®ã‹èª¬æ˜ã‚’ã—ã¦ãã ã•ã„ã€‚

    # å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆJSONï¼‰
    å¿…ãš **æœ‰åŠ¹ãªJSONå½¢å¼** ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
    æ•°å€¤ã«ã¯ã€Œ+ã€ã‚’ä»˜ã‘ãšã€å¼•ç”¨ç¬¦ã®é–‰ã˜å¿˜ã‚Œã‚„ã‚³ãƒ¡ãƒ³ãƒˆã¯å…¥ã‚Œãªã„ã§ãã ã•ã„ã€‚
    {{
      "æ”»æ’ƒæ€§": {{"score": 0-3 }},
      "æŒ‘ç™ºæ€§": {{"score": 0-3 }},
      "æœ‰ç”¨æ€§": {{"score": 0-3 }},
      "æ„Ÿæƒ…æ¥µæ€§": {{"score": -2ã€œ+2 }},
      "è‡ªå·±é¡•ç¤ºæ€§": {{"score": 0-3 }},
      "æ–‡è„ˆä¾å­˜æ€§": {{"score": 0-3 }},
      "ç·åˆã‚³ãƒ¡ãƒ³ãƒˆ": "..."
    }}

    # åˆ†æå¯¾è±¡ã‚³ãƒ¡ãƒ³ãƒˆ
    {comment_text}
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3
        )
        raw_output = response.choices[0].message.content.strip()

        try:
            result = json.loads(raw_output)
        except json.JSONDecodeError:
            result = {"raw_output": raw_output}
        return result

    except Exception as e:
        return {"error": str(e)}

# -----------------------------------------------------------
# ã‚¹ãƒ†ãƒƒãƒ—5ï¼šå…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€æ‹¬åˆ†æã—ã¦CSVä¿å­˜
# -----------------------------------------------------------
def analyze_video_comments(video_url, max_comments=200, save_path="analyzed_comments.csv"):
    # URLã‹ã‚‰å‹•ç”»IDã‚’æŠ½å‡º
    video_id = None
    if "v=" in video_url:
        video_id = video_url.split("v=")[-1].split("&")[0]
    elif "youtu.be/" in video_url:
         video_id = video_url.split("youtu.be/")[-1].split("?")[0]
    
    if not video_id:
        print("âš ï¸ ç„¡åŠ¹ãªYouTube URLã§ã™ã€‚")
        return

    comments = get_youtube_comments(video_id, max_comments)
    if not comments:
        print("ã‚³ãƒ¡ãƒ³ãƒˆãŒå–å¾—ã§ããªã‹ã£ãŸãŸã‚ã€å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
        return

    results = []

    for c in tqdm(comments, desc="Analyzing comments"):
        analysis = analyze_comment(c)
        time.sleep(0.5)  # APIåˆ¶é™å¯¾ç­–

        record = {"ã‚³ãƒ¡ãƒ³ãƒˆ": c}
        record.update({k: v.get("score", None) if isinstance(v, dict) else v for k, v in analysis.items()})
        results.append(record)

    df = pd.DataFrame(results)
    df.to_csv(save_path, index=False)
    print(f"âœ… åˆ†æçµæœã‚’ {save_path} ã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
    return df

# -----------------------------------------------------------
# ã‚¹ãƒ†ãƒƒãƒ—6ï¼šå®Ÿè¡Œï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã ã‘å‹•ãï¼‰
# -----------------------------------------------------------
if __name__ == "__main__":
    print("YouTubeã‚³ãƒ¡ãƒ³ãƒˆä¸€æ‹¬åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ")
    video_url = input("ğŸ¥ åˆ†æã—ãŸã„YouTubeå‹•ç”»ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š")
    if video_url:
        df = analyze_video_comments(video_url, max_comments=50) # ãƒ†ã‚¹ãƒˆç”¨ã«50ä»¶ã«è¨­å®š
        if df is not None:
            print(df.head())